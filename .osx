#!/bin/bash
#
# macOS Configuration Script
# ===========================
#
# Purpose: Configures macOS system preferences, installs/verifies required Homebrew packages,
#          and sets up network preferences for optimized connectivity.
#
# Usage:
#   Run once after setting up a new macOS machine or syncing dotfiles:
#   $ cd ~/.dotfiles
#   $ chmod +x .osx
#   $ ./.osx
#
# What it does:
#   ✓ Finder configuration (sort folders first, show extensions, path bar, etc.)
#   ✓ Dark mode and accessibility preferences (reduce motion)
#   ✓ Dock configuration (auto-hide, resize, disable animations)
#   ✓ Show hidden folders (~/Library, /Volumes)
#   ✓ Ensure Homebrew is installed
#   ✓ Verify required packages (neovim, fzf, tmux, sesh, zoxide, eza, etc.)
#   ✓ Set network priority (10G ethernet over Wi-Fi, requires hardware)
#
# Requirements:
#   - macOS operating system
#   - Internet connection (for Homebrew installation if needed)
#   - Admin/sudo access (for system preferences and network configuration)
#
# Notes:
#   - Network preferences section is hardware-specific and may require adjustment
#   - Script will exit with error if required Homebrew packages are missing
#

# Sort folders first in Finder
defaults write com.apple.finder _FXSortFoldersFirst -bool true

# Show the Size Column: There’s no direct defaults command to force the Size
# column to appear in all Finder windows, as this is typically a per-window
# setting in the GUI. However, you can set List View as the default view (which
# supports the Size column) and rely on manual column addition or a script to
# enforce it:
defaults write com.apple.finder FXPreferredViewStyle -string "Nlsv"

# Show all file extensions in Finder
defaults write NSGlobalDomain AppleShowAllExtensions -bool true

# Show the path bar in Finder
defaults write com.apple.finder ShowPathbar -bool true

# Show the status bar in Finder
defaults write com.apple.finder ShowStatusBar -bool true

# Set the default location for new Finder windows to the user's home directory
defaults write com.apple.finder NewWindowTarget -string "PfHm"

# Disable the warning when emptying the Trash
defaults write com.apple.finder WarnOnEmptyTrash -bool false

# Show the ~/Library folder
chflags nohidden ~/Library

# Show the /Volumes folder
sudo chflags nohidden /Volumes

# Dark mode
defaults write NSGlobalDomain AppleInterfaceStyle -string "Dark"

# Reduce motion
defaults write com.apple.universalaccess reduceMotion -bool true

# Autohide Dock
defaults write com.apple.dock autohide -bool true

# Set Dock size
defaults write com.apple.dock tilesize -int 48

# Set Dock magnification
defaults write com.apple.dock magnification -bool false

# Disable animation when resizing windows
defaults write NSGlobalDomain NSWindowResizeTime -float 0.001
defaults write com.apple.dock launchanim -bool false
defaults write NSGlobalDomain NSAutomaticWindowAnimationsEnabled -bool false

# Ensure Homebrew is installed
if ! command -v brew &> /dev/null; then
  echo -e "\033[0;33mHomebrew is not installed. Installing Homebrew...\033[0m"
  echo ""

  # Check if we're on macOS
  if [[ "$OSTYPE" != "darwin"* ]]; then
    echo -e "\033[0;31mError: This script is designed for macOS. Homebrew installation skipped.\033[0m"
    exit 1
  fi

  # Install Homebrew
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

  # Set up Homebrew in the current shell session
  if [[ -f "/opt/homebrew/bin/brew" ]]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
  elif [[ -f "/usr/local/bin/brew" ]]; then
    eval "$(/usr/local/bin/brew shellenv)"
  fi

  # Verify installation
  if ! command -v brew &> /dev/null; then
    echo -e "\033[0;31mError: Homebrew installation failed. Please install manually: https://brew.sh\033[0m"
    exit 1
  fi

  echo ""
  echo -e "\033[0;32m✓ Homebrew installed successfully!\033[0m"
  echo ""
fi

# Check for required Homebrew packages
echo "Checking for required Homebrew packages..."

# Ensure brew is in PATH for this script
if [[ -f "/opt/homebrew/bin/brew" ]]; then
  eval "$(/opt/homebrew/bin/brew shellenv)" 2>/dev/null || true
elif [[ -f "/usr/local/bin/brew" ]]; then
  eval "$(/usr/local/bin/brew shellenv)" 2>/dev/null || true
fi

# Get list of installed packages
INSTALLED_PACKAGES=$(brew list 2>/dev/null || echo "")

# Required packages referenced in dotfiles
REQUIRED_PACKAGES=(
  "coreutils"      # for timeout command
  "neovim"         # used in aliases, gitconfig, tmux config
  "fzf"            # used in .zshrc and tmux config
  "tmux"           # terminal multiplexer
  "sesh"           # session management
  "zoxide"         # smart directory navigation
  "eza"            # modern ls replacement
  "gum"            # used with sesh in aliases
  "git-delta"      # git diff tool (brew package name)
  "bat"            # cat replacement (used in sesh config)
  "nvm"            # node version manager
)

MISSING_PACKAGES=()

for package in "${REQUIRED_PACKAGES[@]}"; do
  # Check if package is installed
  if ! echo "$INSTALLED_PACKAGES" | grep -q "^${package}$"; then
    MISSING_PACKAGES+=("$package")
  fi
done

# Display warning if packages are missing
if [ ${#MISSING_PACKAGES[@]} -gt 0 ]; then
  echo ""
  echo -e "\033[0;31m═══════════════════════════════════════════════════════════════\033[0m"
  echo -e "\033[0;31m⚠️  WARNING: Missing required Homebrew packages!\033[0m"
  echo -e "\033[0;31m═══════════════════════════════════════════════════════════════\033[0m"
  echo -e "\033[0;31mThe following packages are referenced in your dotfiles but are not installed:\033[0m"
  echo ""
  for pkg in "${MISSING_PACKAGES[@]}"; do
    echo -e "\033[0;31m  • $pkg\033[0m"
  done
  echo ""
  echo -e "\033[0;31mInstall missing packages with:\033[0m"
  echo -e "\033[0;31m  brew install ${MISSING_PACKAGES[*]}\033[0m"
  echo -e "\033[0;31m═══════════════════════════════════════════════════════════════\033[0m"
  echo ""
  exit 1
else
  echo "✓ All required Homebrew packages are installed."
fi

# =============================================================================
# Network: Prefer 10G Ethernet over Wi-Fi
# =============================================================================
echo ""
echo "Setting up network preferences (10G ethernet priority)..."

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ETHERNET_SCRIPT="$SCRIPT_DIR/osx/bin/prefer-ethernet.sh"
ETHERNET_PLIST="$SCRIPT_DIR/osx/LaunchDaemons/com.clifton.prefer-ethernet.plist"

if [[ -f "$ETHERNET_SCRIPT" ]] && [[ -f "$ETHERNET_PLIST" ]]; then
  # Install the script
  sudo cp "$ETHERNET_SCRIPT" /usr/local/bin/prefer-ethernet.sh
  sudo chmod 755 /usr/local/bin/prefer-ethernet.sh
  sudo chown root:wheel /usr/local/bin/prefer-ethernet.sh

  # Install the LaunchDaemon
  sudo cp "$ETHERNET_PLIST" /Library/LaunchDaemons/com.clifton.prefer-ethernet.plist
  sudo chmod 644 /Library/LaunchDaemons/com.clifton.prefer-ethernet.plist
  sudo chown root:wheel /Library/LaunchDaemons/com.clifton.prefer-ethernet.plist

  # Set network service order (Solo 10G first, then other ethernet, then Wi-Fi)
  # Get current services
  if networksetup -listnetworkserviceorder | grep -q "Solo 10G"; then
    echo "  Setting network service order (Solo 10G priority)..."
    sudo networksetup -ordernetworkservices \
      "Solo 10G" \
      "USB 10/100/1000 LAN" \
      "USB 10/100/1G/2.5G LAN" \
      "Thunderbolt Bridge" \
      "Wi-Fi" \
      "Tailscale" 2>/dev/null || true
  fi

  # Unload if already loaded, then load
  sudo launchctl unload /Library/LaunchDaemons/com.clifton.prefer-ethernet.plist 2>/dev/null || true
  sudo launchctl load /Library/LaunchDaemons/com.clifton.prefer-ethernet.plist

  echo "✓ Network preferences configured (10G ethernet prioritized over Wi-Fi)"
else
  echo "⚠ Network preference files not found, skipping..."
fi
