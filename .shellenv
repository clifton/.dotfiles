# Shared shell environment for bash and zsh
# Source this from .bashrc and .zshrc

# Source platform detection
if [ -f "$HOME/.shellenv.d/platform.sh" ]; then
  . "$HOME/.shellenv.d/platform.sh"
fi

# Ensure TERM is supported on this system, fallback if not
# This handles SSH to systems without tmux-256color terminfo (e.g., Synology NAS)
if ! infocmp "$TERM" >/dev/null 2>&1; then
  if infocmp tmux-256color >/dev/null 2>&1; then
    export TERM=tmux-256color
  elif infocmp screen-256color >/dev/null 2>&1; then
    export TERM=screen-256color
  else
    export TERM=xterm-256color
  fi
fi

# UTF-8 locale for proper Unicode/Nerd Font rendering
export LANG="${LANG:-en_US.UTF-8}"
export LC_ALL="${LC_ALL:-en_US.UTF-8}"

# Initialize Homebrew using detected prefix
if [ -n "$DOTFILES_HOMEBREW_PREFIX" ]; then
  eval "$($DOTFILES_HOMEBREW_PREFIX/bin/brew shellenv)"
fi

# Cargo/Rust
if [ -f "$HOME/.cargo/env" ]; then
  . "$HOME/.cargo/env"
fi

# Foundry (Ethereum development)
if [ -d "$HOME/.foundry" ]; then
  export PATH="$PATH:$HOME/.foundry/bin"
fi

# Local binaries
export PATH="$PATH:$HOME/.local/bin"

# pnpm
if [ -d "$HOME/Library/pnpm" ]; then
  export PNPM_HOME="$HOME/Library/pnpm"
elif [ -d "$HOME/.local/share/pnpm" ]; then
  export PNPM_HOME="$HOME/.local/share/pnpm"
fi
if [ -n "$PNPM_HOME" ]; then
  case ":$PATH:" in
    *":$PNPM_HOME:"*) ;;
    *) export PATH="$PNPM_HOME:$PATH" ;;
  esac
fi

# Antigravity
if [ -d "$HOME/.antigravity/antigravity/bin" ]; then
  export PATH="$HOME/.antigravity/antigravity/bin:$PATH"
fi

# NVM settings
export NVM_COMPLETION=true
export NVM_SYMLINK_CURRENT="true"

# MySQL client alias (Linuxbrew)
if [ -f "/home/linuxbrew/.linuxbrew/opt/mysql-client/bin/mysql" ]; then
  alias mysql="/home/linuxbrew/.linuxbrew/opt/mysql-client/bin/mysql"
fi

# WSL environment
if [ -f /proc/version ] && grep -q "microsoft" /proc/version 2>/dev/null; then
  WINDOWS_DIR=$(wslpath -u "$(wslvar SYSTEMROOT)" 2>/dev/null)
  if [ -n "$WINDOWS_DIR" ]; then
    explorer() { "${WINDOWS_DIR}/explorer.exe" "$@"; }
    cmd() { "${WINDOWS_DIR}/system32/cmd.exe" "$@"; }
  fi
  export XDG_RUNTIME_DIR="$HOME/.xdg_runtime"
  if [ ! -d "$XDG_RUNTIME_DIR" ]; then
    mkdir -p "$XDG_RUNTIME_DIR"
    chmod 0700 "$XDG_RUNTIME_DIR"
  fi
fi

# Source aliases
if [ -f "$HOME/.aliases" ]; then
  . "$HOME/.aliases"
fi

# Source local machine-specific config
if [ -f "$HOME/.config.local" ]; then
  . "$HOME/.config.local"
fi

# Source local environment variables (secrets)
if [ -f "$HOME/.env" ]; then
  . "$HOME/.env"
fi
